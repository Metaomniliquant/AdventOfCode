name: Advent of Code CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test-bdd:
    name: Run BDD Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Cucumber tests
      run: npm test
      
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cucumber-results
        path: cucumber-report.json
        if-no-files-found: ignore

  validate-structure:
    name: Validate Folder Structure
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate year folders
      run: |
        echo "Validating folder structure..."
        # Check that year folders follow naming convention (4 digits)
        for dir in */; do
          if [[ -d "$dir" && ! "$dir" =~ ^(node_modules|\.github|features|src|test-workspace)/ ]]; then
            dirname="${dir%/}"
            if [[ "$dirname" =~ ^[0-9]{4}$ ]]; then
              echo "✓ Valid year folder: $dirname"
            fi
          fi
        done
        
    - name: Validate day folders
      run: |
        echo "Validating day folder structure..."
        # Check that day folders are zero-padded
        for yeardir in [0-9][0-9][0-9][0-9]/; do
          if [[ -d "$yeardir" ]]; then
            for daydir in "${yeardir}"day*/; do
              if [[ -d "$daydir" ]]; then
                dayfolder=$(basename "$daydir")
                if [[ "$dayfolder" =~ ^day[0-9]{2}$ ]]; then
                  echo "✓ Valid day folder: $daydir"
                else
                  echo "✗ Invalid day folder: $daydir (should be dayXX with zero-padding)"
                  exit 1
                fi
              fi
            done
          fi
        done

  test-javascript:
    name: Test JavaScript Solutions
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, 'javascript') ||
      contains(github.event.pull_request.title, 'javascript') ||
      github.event_name == 'push'
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Find and test JavaScript solutions
      run: |
        echo "Looking for JavaScript solutions..."
        find . -path "*/javascript/solution.test.js" -type f | while read testfile; do
          dir=$(dirname "$testfile")
          echo "Running tests in $dir"
          cd "$dir"
          if [ -f "package.json" ]; then
            npm install
            npm test
          fi
          cd -
        done

  test-python:
    name: Test Python Solutions
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, 'python') ||
      contains(github.event.pull_request.title, 'python') ||
      github.event_name == 'push'
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install pytest
      run: pip install pytest
        
    - name: Find and test Python solutions
      run: |
        echo "Looking for Python solutions..."
        find . -path "*/python/test_*.py" -type f | while read testfile; do
          dir=$(dirname "$testfile")
          echo "Running tests in $dir"
          cd "$dir"
          pytest -v
          cd -
        done

  test-go:
    name: Test Go Solutions
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, 'go') ||
      contains(github.event.pull_request.title, 'go') ||
      github.event_name == 'push'
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        
    - name: Find and test Go solutions
      run: |
        echo "Looking for Go solutions..."
        find . -path "*/go/*.go" -type f | while read gofile; do
          dir=$(dirname "$gofile")
          echo "Testing Go code in $dir"
          cd "$dir"
          if ls *_test.go 1> /dev/null 2>&1; then
            go test -v
          fi
          cd -
        done

  continuous-delivery:
    name: Continuous Delivery Check
    runs-on: ubuntu-latest
    needs: [test-bdd, validate-structure]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: CD Principles Validation
      run: |
        echo "✓ Automated testing completed"
        echo "✓ Folder structure validated"
        echo "✓ Multi-language support active"
        echo "✓ Continuous Delivery principles applied"
